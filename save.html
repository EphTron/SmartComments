<!DOCTYPE html>
<html>
    <head>
        <title>Visu Beleg</title>
		<link rel="stylesheet" href="indexstyle.css">
		<script type="text/javascript" src="d3/d3.v3.js"></script>
		<meta charset="UTF-8">
    </head>
    <body>
				
		<div class="wrapper">
			<div class="mainFrame">
			
				<h1>Product</h1>
				<div class="productPicture">
					<img src="./pictures/bag.png" alt="Picture Bag">
				</div>
				<div class="productInfo">
					<h4>MUMIENSCHLAFSACK LIGHT 600 4651</h4>
					<p>von Unbekannt</p>
					<p><img src="./pictures/stars.png" alt="Picture Stars"> 84 Kundenrezensionen</p>
					<p>Preis:  17,90</p>
					<p>AUF LAGER</p>
				</div>
				
				<div class="smartComments">
					<h4>Kundenrezensionen</h4>
					<div class="barChart">
					</div>
					<div class="textBox">
						<p class="textNummer"></p>
						<p class="textTitle"></p>
						<p class="textInfo"></p>
						
					</div>
				</div>
			</div>
		</div>
		
		<script type="text/javascript">
			  
			var w = 1100;
			var h = 50;
			var bar_padding = 5;
			var animate = 1.5;
			var clickcounter = 0;
			var lastID = -1;
			
			var dataset;
			d3.csv("bag.csv", function(error,data){
				if(error) {
					console.log(error);
				} else {
					dataset = data;
					drawBarChart(data);
				}
			});
			
			function drawBarChart(data) {
				var minRate = d3.min(data,function(d) {parseInt(d.rating)});
				var maxRate = d3.max(data,function(d) {parseInt(d.rating)});
				
				var minHelpful = d3.min(data,function(d) {parseInt(d.helpPos)});
				var maxHelpful = d3.max(data,function(d) {parseInt(d.helpPos)});
				
				var ttl = 0;
				for (var i = 0; i < data.length; i++){
					ttl += parseInt(data[i].rating);
				}
				
				var svg = d3.select(".barChart")
					        .append("svg")
							.attr("width", w)
							.attr("height", h + 10);
							
				var bars = svg.selectAll("rect")
							  .data(data)
							  .enter()
							  .append("rect");
							  
				var scl = d3.scale.linear()
								  .domain([0,ttl])
								  .range([0,w]);
								  
				var colScl = d3.scale.linear()
								  .domain([minHelpful,maxHelpful])
								  .range([0,255]);
								  
				var textBox = d3.select(".smartComments")
				                .select(".textBox")
								
				
				bars.attr("id", function(d,i) { return "r" + i; })
				    .attr("x", function(d,i) { return calcX(d,i,scl,svg); })
					.attr("y", 0)
				    .attr("width", function(d,i) { return calcWidth(d,i,scl) })
					.attr("height", h)
					.attr("fill", function(d) {
					    return "rgb(100,100," + (calcColor(d,colScl)) + ")";
					})
					.on("mouseover",  function(d,i) {
						showInfo(d);
					})
					.on("mouseout", function(d) {
						bars.transition()
							.duration(200)
							.attr("fill", function(d){
						return "rgb(" + (255-calcColor(d,colScl)) +",100," + (calcColor(d,colScl)) + ")";
						});

						if((clickcounter % 2) == 0) {
							// div will not fold back together if clicked once
							// if clicked again the div will fold back to the top
						answer.transition()  
							  .duration(200)
							  .style("border", "0px solid black")
							  .style("width", "800px")
							  .style("height", "0px");
						datablock.text("");
						}
					})
					.on("click", function(d) {
						clickcounter += 1;
					});
							  
			}
			
			function showInfo(data){
				d3.select(".textNr")
				  .text("Kundenrezension Nr.:" + data.id + " von " + data.name);
				  
				d3.select(".textInfo")
				  .text("Sterne: "+ data.rating + "\n" + data.infoText);
				var rectX = svg.select("#r"+parseInt(d.id)).attr("x");
				var rectW = svg.select("#r"+parseInt(d.id)).attr("width");
				var rectcenter = (parseFloat(rectW/2)) + parseFloat(rectX);

				if(rectcenter < 400)
					textBox.transition()
						.duration(300)
						.style("width", "800px")
						.style("height", "200px")
						.style("margin-left", "0px");
				else if (rectcenter > (w-400))
					textBox.transition()
						.duration(300)
						.style("width", "800px")
						.style("height", "200px")
						.style("margin-left", (w-800)+"px");
				else 
					textBox.transition()
						.duration(300)
						.style("width", "800px")
						.style("height", "200px")
						.style("margin-left", (rectcenter-400)+"px");

				
				lastID = parseInt(d.id);

				svg.select("#r"+parseInt(d.id))
					.transition()
					.duration(200)
					.attr("fill","orange");
			}
			
			function calcWidth(d,i,scale) {
				return scale(parseInt(dataset[i].rating));
			}
			
			function calcColor(d,colScl) {
				return colScl(parseInt(dataset.helpPos));
			}

			function calcX(d,i,scale,svg) {
				if(i == 0) {
					return 0;
				} else {
					var wold = calcWidth(dataset,i-1,scale);
					var xold = svg.select("#r"+(i-1)).attr('x');
					return parseFloat(xold) + wold; 
				}
			}

			
			d3.select(".smartComments").selectAll("p")
			  .data(dataset)
			  .enter()
			  .append("p")
			  .text(function(data,i) { return i; });
		</script>
		
    </body>
</html>