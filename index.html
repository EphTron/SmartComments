<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tutorial index</title>
  <script type="text/javascript" src="lib/d3/d3.js"></script>
  <link rel="stylesheet" type"text/css" href="style.css">
</head>
<body>

  <script type="text/javascript">
    var w = window.innerWidth -20;
    var h = 50;
    var bar_padding = 5
    var blowup = 1.5;
    var clickcounter = 0;
    var lastID = -1;

    var dataset;
    d3.csv("ages.csv", function(error,data) {
      if(error) {s
        console.log(error);
      }
      else {
        dataset = data;
        drawBarChart(data);
      }
    });

    function drawBarChart(data) {

      // get greatest value 
      var max = d3.max(data,function(d) { return parseInt(d.age) });
      var min = d3.min(data,function(d) { return parseInt(d.age) });

      // calc total of dataset
      var ttl = 0;
      for(var i = 0; i < data.length; i++)
        ttl += parseInt(data[i].age);

      // add menu items
      var menu = d3.select("body")
                   .select("p.menu");

      //setup svg objects
      var svg = d3.select("body")
                  .select("div.topbars")
                  .append("svg")
                  .attr('width', w)
                  .attr('height', h+10);

      // define bars
      var bars = svg.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect");

      // define scale
      var scale = d3.scale.linear()
                    .domain([0, ttl])
                    .range([0, w]);

      var answer = d3.select("body").select("div.answer");
      var datablock = answer.select("p.data");

      // create dynamic bars
      bars.attr("id", function(d,i) { return "r" + i; })
          .attr("x", function(d,i) { return calcX(d,i,scale,svg); })
          .attr("y", 0)
          .attr("width", function(d,i) { return calcWidth(d,i,scale) })
          .attr("height", h)
          .attr("fill", function(d) {
                  return "rgb(40,100," + (d.age*2) + ")";
                })
          .on("mouseover",  function(d,i) {
                var rectX = svg.select("#r"+parseInt(d.id)).attr("x");
                var rectW = svg.select("#r"+parseInt(d.id)).attr("width");
                var rectcenter = (parseFloat(rectW/2)) + parseFloat(rectX);

                if(rectcenter < 400)
                  answer.transition()
                        .duration(300)
                        .style("width", "800px")
                        .style("height", "200px")
                        .style("margin-left", "0px");
                else if (rectcenter > (w-400))
                  answer.transition()
                        .duration(300)
                        .style("width", "800px")
                        .style("height", "200px")
                        .style("margin-left", (w-800)+"px");
                else 
                  answer.transition()
                        .duration(300)
                        .style("width", "800px")
                        .style("height", "200px")
                        .style("margin-left", (rectcenter-400)+"px");
  
                datablock.text(d.name+" = "+d.age);
                lastID = parseInt(d.id);

                svg.select("#r"+parseInt(d.id))
                   .transition()
                   .duration(200)
                   .attr("fill","orange");
              })
          .on("mouseout", function(d) {
                bars.transition()
                    .duration(200)
                    .attr("fill", function(d){
                           return "rgb(40,100," + (d.age*2) + ")";
                         });

                if((clickcounter % 2) == 0) {
                  // div will not fold back together if clicked once
                  // if clicked again the div will fold back to the top
                  answer.transition()  
                        .duration(200)
                        .style("border", "0px solid black")
                        .style("width", "800px")
                        .style("height", "0px");
                  datablock.text("");
                }
              })
          .on("click", function() {
                //clickcounter += 1;
                sortBars(svg,scale);
              });
    }

    function calcWidth(d,i,scale) {
      return scale(parseInt(dataset[i].age));
    }

    function calcX(d,i,scale,svg) {
      if(i == 0) {
        return 0;
      }
      else {
        var wold = calcWidth(dataset,i-1,scale);
        var xold = svg.select("#r"+(i-1)).attr('x');
        return parseFloat(xold) + wold; 
      }
    }

    function sortBars(svg,scale) {
      svg.selectAll("rect")
         .sort(function(a,b) { 
            return d3.ascending(a,b);
          })
         .transition()
         .duration(1000)
         .attr("x", function(d,i) { 
            return calcX(d,i,scale,svg);
          });

    }

  </script>

  <div class="headline">
    <p><h1>SmartComments</h1></p>
    <p class="menu"></p>
  </div>

  <div class="topbars"></div>
  
  <div class="answer">
    <p class="data"></p>
  </div>

</body>
</html>
