<!DOCTYPE html>
<html>
  <head>
      <title>Visu Beleg</title>
      <link rel="stylesheet" href="indexstyle.css">
      <script type="text/javascript" src="d3/d3.v3.js"></script>
      <script type="text/javascript" src="jQuery/jquery-2.1.1.min.js"></script>
      <!-- <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script> -->
      <meta charset="UTF-8">
  </head>
  <body>
    <div class="wrapper">
      <div class="main">
        <div class="productFrame">
          <img src="./pictures/leatherAmazon.png" alt="Picture Bag" width="1400">
          <!-- <h1>Product</h1>
            <div class="productPicture">
             <img src="./pictures/amazonSeite.png" alt="Picture Bag">
            </div>
            <div class="productInfo">
              <h4>MUMIENSCHLAFSACK LIGHT 600 4651</h4>
              <p>von Unbekannt</p>
              <p><img src="./pictures/stars.png" alt="Picture Stars"> 84 Kundenrezensionen</p>
              <p>Preis:  17,90</p>
              <p>AUF LAGER</p>
            </div> -->
        </div>
          <div class="smartComments">
              <h4>Kundenrezensionen</h4>
              <div class="sortButtons" unselectable="yes" onselectstart="return false">
              </div>
              <div class="barChart">
              </div>
              <div class="textBox">
                <div class="textNr"></div>
                <div class="textAuthor"></div>
                <div class="textStars"></div>
                <div class="textTitle"></div>
                <div class="textInfo"></div>
                <div class="textHelp"></div>
                <div class="answerChart"></div>
                <div class ="answerBox" style="display:none">
                  <div class="aTextNr"></div>
                  <div class="aTextAuthor"></div>
                  <div class="aTextInfo"></div>
                  <div class="aTextHelp"></div>
                </div>
              </div>
          </div>
      </div>
    </div>

    <script type="text/javascript">

      var w = window.innerWidth - 50;
      var h = 50;
      var lastID = -1;
      var minHelpAvg = 0;
      var maxHelpAvg = 0;
      var totalWidth = 0;
      var curWidth = 0;
      var correct = 0;
      var posArray = [];
      var sortMode = 0;
      var clicked = 1;
      var mostHelpfulId = 0;
      var activeId = 0;
      var activeAId = 0;
      var showPara = 3;
      var dataset = [];
      var answerSet = [];
      var aMinHelpAvg = 0;
      var aMaxHelpAvg = 0;
      var aShowPara = 0;
      // TO DO today: addButton; answer visualization; write down some answers; activeButton color;
      // TO DO general: add barchartdiagramm; add brushing and linkin; adjust text style;
      d3.csv("leatherAnswers.csv", function(error,data){
        if(error) {
          console.log(error);
        } else {
          answerSet = data;
          
          answerSet.forEach(function(d) {
          d["helpNeg"] = (d.helpAll - d.helpPos);
          d["helpAvg"] = (d.helpPos - d.helpNeg);
          });
          aMinHelpAvg = d3.min(data,function(d) {
            return parseInt(d.helpAvg);
          });
          aMaxHelpAvg = d3.max(data,function(d) {
            return parseInt(d.helpAvg)
          });
        }
      });
      var dataset;
      d3.csv("leather.csv", function(error,data){
        if(error) {
          console.log(error);
        } else {

          dataset = data;
          ///console.log(answerSet);
          //dataset.push({id:dataset.length,
          //  ref: "XX",
          //  product:"B00",
          //  rating:"5.0",
          //  helpPos:"0",
          //  helpAll:"0",
          //  date: "August 2, 2014",
          //  userId: "Ephra",
          //  infoTitle: "schleeecht",
          //  infoText: "kann einfach gar nix das teil"
          //});
          dataset.forEach(function(d) {
            d["helpNeg"] = (d.helpAll - d.helpPos);
            d["helpAvg"] = (d.helpPos - d.helpNeg);
          });
          minHelpAvg = d3.min(data,function(d) {
            return parseInt(d.helpAvg);
          });
          maxHelpAvg = d3.max(data,function(d) {
            return parseInt(d.helpAvg)
          });
          
          //console.log(dataset);
          dataset.forEach(function(d) {
            totalWidth += mapTo(d.helpAvg);
          });

          var w_tmp = 0;
          dataset.forEach(function(d) {
            w_tmp += mapToScreen(d.helpAvg);
          });

          if (w_tmp > w){
            correct = (w_tmp - w);
          }else if (w_tmp < w){
            correct = (w_tmp - w);
          }

          dataset.forEach(function(d,i) {
            posArray.push({id: d.id, width: mapToScreen(d.helpAvg), stars: (d.rating*100)+(mapTo(d.helpAvg))+(d.id/1000), x: curWidth});
            curWidth += mapToScreen(d.helpAvg);
            if (parseInt(d.helpAvg) > parseInt(dataset[mostHelpfulId].helpAvg)) {
              mostHelpfulId = d.id;
            }
          });
          activeId = mostHelpfulId;
          var setupData = [];
          setupData = setup(dataset);

          draw(dataset,posArray,setupData);
        }
      });

      function setup(data) {
        //bar setup
        var barSVG = d3.select(".barChart")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h+10);
        var bars = barSVG.selectAll("rect")
                         .data(data)
                         .enter()
                         .append("rect");

        var pointer = barSVG.append("polygon");

        var textBox = d3.select(".smartComments")
                        .select(".textBox")

        var colorScale = d3.scale.linear()
                           .domain([minHelpAvg,0,maxHelpAvg])
                           .range(["red","lightgray","green"]);

        //button setup
        var buttArray = [{id:0 ,state:"sort by: helpful", value:1},
                         {id:1 ,state:"sort by: number",  value:2},
                         {id:2 ,state:"sort by: stars",   value:3},
                         {id:3 ,state:"none",    value:4},
                         {id:4 ,state:"none",    value:5}];

        var buttonSVG = d3.select(".sortButtons")
                          .append("svg")
                          .attr("width", w)
                          .attr("height", 30);

        var buttons = buttonSVG.selectAll("rect")
                               .data(buttArray)
                               .enter()
                               .append("rect");

        var labels = buttonSVG.selectAll("text")
                              .data(buttArray)
                              .enter()
                              .append("text");

        //marker setup
        var marker = buttonSVG.selectAll("polygon")
                              .data(buttArray)
                              .enter()
                              .append("polygon");
                           
        var values = [buttonSVG,barSVG,bars,buttons,labels,buttArray,marker,textBox,colorScale,pointer];
        return values;
      }

      function draw(data,posArray,setupData) {

        var buttonSVG = setupData[0];
        var barSVG    = setupData[1];
        var bars      = setupData[2];
        var buttons   = setupData[3];
        var labels    = setupData[4];
        var buttArray = setupData[5];
        var marker    = setupData[6];
        var textBox   = setupData[7];
        var colScl    = setupData[8];
        var pointer   = setupData[9];

        var bCnt = buttArray.length; // buttonCount

        pointer.attr("id", "p")
               .style("fill", "white")
               .style("stroke", "white");

        bars.attr("id", function(d,i) { return "r" + i; })
            .attr("x", function(d,i) { return posArray[i].x })
            .attr("y", 0)
            .attr("width", function(d,i) { return posArray[i].width })
            .attr("height", h)
            .attr("stroke", "white")
            .attr("fill", function(d) {return colScl(d.helpAvg);})
            .on("mouseover",  function(d,i) {
              if(showPara != 2){
                if (showPara == 3){
                barSVG.select("#r"+parseInt(activeId))
                   .transition()
                   .duration(100)
                   .attr("fill", colScl(dataset[activeId].helpAvg));
                }
                showPara = 1;
                activeId = d.id;
              
                var rectX = findByID(posArray,i).x;
                var width = findByID(posArray,i).width;
                var x1 = parseFloat(rectX)+parseFloat(width/2);
                showInfo(textBox,rectX);
                
                barSVG.select("#r"+parseInt(d.id))
                    .transition()
                    .duration(100)
                    .attr("fill", "#66CCFF");

                barSVG.select("#p")
                      .transition()
                      .duration(100)
                      .style("fill", "#66CCFF")
                      .style("stroke", "#66CCFF")
                      .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );
              }
            })
            .on("mouseout",function (d) {
              if(showPara != 2){
                
                barSVG.select("#r"+parseInt(d.id))
                   .transition()
                   .duration(100)
                   .attr("fill", colScl(d.helpAvg));
                barSVG.select("#p")
                      .transition()
                      .duration(50)
                      .style("fill", "white")
                      .style("stroke", "white");
                showPara = 0;
                activeId = d.id;
                showInfo(textBox);
              }
            })
            .on("click", function (d) {
              if (showPara == 1 || showPara == 0){
                showPara = 2;
                activeId = d.id;
                console.log("clicked ->"+ showPara);
                drawAnswers(answerSet,d.id);
              } else if (showPara == 2){
                barSVG.select("#r"+parseInt(activeId))
                 .transition()
                 .duration(100)
                 .attr("fill", colScl(dataset[activeId].helpAvg));

                showPara = 1;
                activeId = d.id;;
                console.log("clicked again ..."+showPara);
                
                var rectX = findByID(posArray,activeId).x;

                showInfo(textBox,rectX);
                barSVG.select("#r"+parseInt(d.id))
                  .transition()
                  .duration(100)
                  .attr("fill", "#66CCFF");

                var width = findByID(posArray,activeId).width;
                var x1 = parseFloat(rectX) + parseFloat(width/2);
                barSVG.select("#p")
                      .transition()
                      .duration(100)
                      .style("fill", "#66CCFF")
                      .style("stroke", "#66CCFF")
                      .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );
              }
            });
        //set  position and color of marker and activeId rect on FIRST VISIT
        firstVisitInit(textBox);

        buttons.attr("id", function(d,i) { return "b"+i; })
               .attr("active", false)
               .attr("x", function(d,i) { return i*(w/bCnt); })
               .attr("y", 0)
               .attr("width", function(d,i) { return (w/bCnt)-20; })
               .attr("height", 25)
               .attr("rx", 6)
               .attr("ry", 6)
               .attr("stroke", "black")
               .attr("fill", "lightgrey")
               .on("mouseover", function(d){
                  buttonSVG.select("#b"+parseInt(d.id))
                    .transition()
                    .duration(100)
                    .attr("fill", "lightblue");
                })
               .on("mouseout", function(d){
                  buttonSVG.select("#b"+parseInt(d.id))
                    .transition()
                    .duration(100)
                    .attr("fill", "lightgrey");
                })
               .on("click", function(d) {
                  buttonSVG.select("#b"+parseInt(d.id))
                    .transition()
                    .duration(100)
                    .attr("fill", "lightblue")
                  clicked = clicked*-1;
                  var buttonState = clicked*d.value;
                  sortBars(posArray,barSVG,buttonState,textBox);
                  changeMarkerState(buttonSVG,marker,buttonState,d.id);
                });

        labels.attr("id", function(d,i) { return "l"; })
              .text(function(d,i) { return buttArray[i].state; })
              .attr("x", function(d,i) { return i*(w/bCnt) + ((w/bCnt)/2-10);  })
              .attr("y", 18)
              .attr("width", function(d,i) { return (w/bCnt)-20; })
              .attr("height", 20)
              .attr("text-anchor", "middle");

        marker.attr("id", function(d,i) { return "m"+i; })
              .style("stroke", "black")
              .style("fill", "black")
              .attr("points", function(d,i) {
                  return ((i*(w/bCnt)+(w/bCnt)-40)+","+8+","+
                          (i*(w/bCnt)+(w/bCnt)-40)+","+18+","+
                          (i*(w/bCnt)+(w/bCnt)-30)+","+13);
              });
      }

      function showInfo(textBox,rectX){
        if (showPara == 1 || showPara == 3){
          d3.select(".textBox")
            .style("display", "block");
          d3.select(".textBox")
            .select(".textNr")
            .text("Nr.:" + dataset[activeId].id);
          d3.select(".textBox")
            .select(".textInfo")
            .text("Sterne: "+ dataset[activeId].rating + "\n" + dataset[activeId].infoText);
          if (showPara != 2) {
            textStyle(textBox,rectX,250);
          }
        }
        else if(showPara == 0){
         console.log("i dont care "+showPara);
          d3.select(".textBox")
            .style("display", "none");
          d3.select(".textBox")
            .select(".textNr")
            .text("");
          d3.select(".textBox")
            .select(".textInfo")
            .text("");
        }
      }

      function textStyle(textBox,rectX,delay) {
        if(rectX < 400) {
          textBox.transition()
            .duration(delay)
            .style("margin-left", 17+"px");
        } else if (rectX > (w-400)) {
         textBox.transition()
            .duration(delay)
            .style("margin-left", (w-800+7)+"px");
        } else {
          textBox.transition()
            .duration(delay)
            .style("margin-left", (rectX-400+17)+"px");
        }
      };
      
      function answerStyle(textBox,rectX,delay) {
        if(rectX < 200) {
          textBox.transition()
            .duration(delay)
            .style("margin-left", 0+"px");
        } else if (rectX > (600)) {
         textBox.transition()
            .duration(delay)
            .style("margin-left", (400)+"px");
        } else {
          textBox.transition()
            .duration(delay)
            .style("margin-left", (rectX-200)+"px");
        }
      };
      
      function drawAnswers(answerSet,id){
        //setup the right answers
        var subSet = [];
        answerSet.forEach(function(d,i) {
          if (d.ref == id){
            subSet.push(d);
          }
        });
         subSet.forEach(function(d,i) {
          d["id"] = i;
        });
        //setup sizes and colors
        var aW = (780/subSet.length);
        console.log(subSet);
        
        // draw
        var answerBox = d3.select(".smartComments")
                          .select(".textBox")
                          .select(".answerBox");
        
        var answerSVG = d3.select(".answerChart")
                    .append("svg")
                    .attr("width", 780)
                    .attr("height", 60);
        var answers = answerSVG.selectAll("rect")
                         .data(subSet)
                         .enter()
                         .append("rect");

        var ansPointer = answerSVG.append("polygon")
        
        ansPointer.attr("id", "aP")
                  .style("fill", "white")
                  .style("stroke", "white");
        
        answers.attr("id", function(d,i) { return "aR" + i; })
              .attr("x", function(d,i) { return aW*i })
              .attr("y", 0)
              .attr("width", function(d,i) { return aW })
              .attr("height", h)
              .attr("stroke", "white")
              .attr("fill", "lightgrey")
              .on("mouseover",  function(d,i) {
                if(aShowPara != 2){
                  aShowPara = 1;
                  activeAId = d.id;
                  var rectX = aW*i;
                  var x1 = parseFloat(rectX)+parseFloat(aW/2);
                  showAnswer(subSet,answerBox,rectX);
                  console.log("AR = " + parseInt(d.id));
                  answerSVG.select("#aR"+parseInt(d.id))
                      .transition()
                      .duration(100)
                      .attr("fill", "#66CCFF");

                  answerSVG.select("#aP")
                        .transition()
                        .duration(100)
                        .style("fill", "#66CCFF")
                        .style("stroke", "#66CCFF")
                        .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );
                }
            })
            .on("mouseout",function (d) {
              if(aShowPara != 2){
                
                answerSVG.select("#aR"+parseInt(d.id))
                   .transition()
                   .duration(100)
                   .attr("fill", "lightgray");
                answerSVG.select("#aP")
                      .transition()
                      .duration(50)
                      .style("fill", "white")
                      .style("stroke", "white");
                aShowPara = 0;
                activeAId = d.id;
                showAnswer(subSet,answerBox);
              }
            })
            .on("click", function (d) {
              if (aShowPara == 1 || aShowPara == 0){
                aShowPara = 2;
                activeAId = d.id;
                console.log("clicked ->"+ aShowPara);
              } else if (aShowPara == 2){
                answerSVG.select("#aR"+parseInt(activeId))
                 .transition()
                 .duration(100)
                 .attr("fill", "lightgray");
                 //.attr("fill", colScl(subSet[activeAId].helpAvg));

                aShowPara = 1;
                activeId = d.id;;
                console.log("clicked again ..."+aShowPara);
                
                var rectX = aW*d.id;
                showAnswer(subSet,answerBox,rectX);
                answerSVG.select("#aR"+parseInt(d.id))
                  .transition()
                  .duration(100)
                  .attr("fill", "#66CCFF");

                var x1 = parseFloat(rectX) + parseFloat(aW/2);
                answerSVG.select("#aP")
                      .transition()
                      .duration(100)
                      .style("fill", "#66CCFF")
                      .style("stroke", "#66CCFF")
                      .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );
              }
            });
      }
      
      function showAnswer(subSet,textHandle,rectX){
        if (aShowPara == 1){
          d3.select(".answerBox")
            .style("display", "block");
          d3.select(".answerBox")
            .select(".aTextNr")
            .text("Nr.:" + subSet[activeAId].id);
          d3.select(".answerBox")
            .select(".aTextInfo")
            .text("Says:" + subSet[activeAId].infoText);
          if (aShowPara != 2) {
            answerStyle(textHandle,rectX,250);
          }
        }
        else if(aShowPara == 0){
         console.log("i dont care "+aShowPara);
          d3.select(".answerBox")
            .style("display", "none");
          d3.select(".answerBox")
            .select(".aTextNr")
            .text("");
          d3.select(".answerBox")
            .select(".aTextInfo")
            .text("");
        }
      }

      function mapToScreen(val) {
        var m = d3.scale.linear()
								  .domain([0,totalWidth])
								  .range([1,w-correct]);
        return m(mapTo(val));
      }
      
      function mapToTextBox(val,maxW,aCorrect) {
        var m = d3.scale.linear()
								  .domain([0,maxW])
								  .range([1,800-aCorrect]);
        return m(mapTo(val));
      }

      function mapTo(val) {
        var s = d3.scale.linear()
                  .domain([minHelpAvg,maxHelpAvg])
                  .range([1,10]);
        return s(val);
      }

      var sortBars = function(posArray,svg,buttonState,textBox) {
        curWidth = 0;

        if(buttonState == 1) {
          posArray.sort(function(a,b) {
            return a.width - b.width;
          });
        } else if(buttonState == -1){
          posArray.sort(function(a,b) {
            return b.width - a.width;
          });
        } else if(buttonState == 2) {
          posArray.sort(function(a,b) {
            return a.id - b.id;
          });
        } else if(buttonState == -2) {
            posArray.sort(function(a,b) {
            return b.id - a.id;
          });
        } else if (buttonState == 3) {
            posArray.sort(function(a,b) {
            return a.stars - b.stars;
          });
        } else if (buttonState == -3) {
            posArray.sort(function(a,b) {
            return b.stars - a.stars;
          });
        }

        posArray.forEach(function(d,i) {
          var w_tmp = posArray[i].width;
          posArray[i].x = curWidth;
          curWidth += w_tmp;
          svg.select("#r"+(posArray[i].id))
             .transition()
             .duration(1000)
             .attr("x", function(d) {
                return posArray[i].x;
              });
             //.attr("fill", function(d,i) {
             //   return ("rgb("+(d.rating* 40)+","+(d.rating*40)+",0)")
             //});
        });
        var rectX = findByID(posArray,activeId).x;
        var width = findByID(posArray,activeId).width;
        var x1 = parseFloat(rectX) + parseFloat(width/2);
        console.log("x = " + x1);
        if(showPara == 2 || showPara == 3){
          svg.select("#p")
              .transition()
              .duration(1000)
              .style("fill", "#66CCFF")
              .style("stroke", "#66CCFF")
              .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );
        }
        textStyle(textBox,rectX,1000);
      }

      function changeMarkerState(svg,marker,buttonState,buttonID) {
        //console.log(buttonID);
        var points = svg.select("#m"+buttonID).attr("points");
        var pntArray = points.split(",").map(Number);

        if(buttonState > 0) {
          svg.select("#m"+buttonID)
             .attr("transform", "rotate("+180+","+(pntArray[0]+5) +","+pntArray[5]+")");
        } else if (buttonState < 0) {
          svg.select("#m"+buttonID)
             .attr("transform", "rotate("+360+","+(pntArray[0]+5) +","+pntArray[5]+")");
        }
      }
      
      function firstVisitInit(textBox) {
        var width = findByID(posArray,activeId).width;
        var x = findByID(posArray,activeId).x;
        var x1 = parseFloat(x) + parseFloat(width/2);
        d3.select(".barChart")
              .select("#r"+parseInt(activeId))
              .transition()
              .duration(100)
              .attr("fill", "#66CCFF");
        showInfo(textBox,x);
        textStyle(textBox,x,250);
  
        d3.select(".barChart")
          .select("#p")
          .transition()
          .duration(100)
          .style("fill", "#66CCFF")
          .style("stroke", "#66CCFF")
          .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );
      }

      function findByID(src,id) {
        return src.filter( function(obj) {
          return +obj.id == id;
        })[0];
      }

    </script>
  </body>
</html>
