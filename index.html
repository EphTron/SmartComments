<!DOCTYPE html>
<html>
  <head>
      <title>Visu Beleg</title>
      <link rel="stylesheet" href="indexstyle.css"> 
      <script type="text/javascript" src="d3/d3.v3.js"></script>
      <script type="text/javascript" src="jQuery/jquery-2.1.1.min.js"></script>
      <!-- <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script> --> 
      <meta charset="UTF-8">
  </head>
  <body>
    <div class="wrapper">
      <div class="main">

        <section class="page1">
        <div class="productFrame">
            <h1>Product</h1>
            <div class="productPicture">
              <img src="./pictures/bag.png" alt="Picture Bag">
            </div>
            <div class="productInfo">
              <h4>MUMIENSCHLAFSACK LIGHT 600 4651</h4>
              <p>von Unbekannt</p>
              <p><img src="./pictures/stars.png" alt="Picture Stars"> 84 Kundenrezensionen</p>
              <p>Preis:  17,90</p>
              <p>AUF LAGER</p>
            </div>
        </div>
        </section>

        <section class="page2">
          <div class="smartComments">
              <h4>Kundenrezensionen</h4>
              <div class="barChart"></div>
              <div class="sortButtons" unselectable="yes" onselectstart="return false"></div>
              <div class="horizontalChart"></div>
              <div class="textBox">
                <div class="textNr"></div>
                <div class="textAuthor"></div>
                <div class="textStars"></div>
                <div class="textTitle"></div>
                <div class="textInfo"></div>
                <div class="textHelp"></div>
              </div>
          </div>
        </section>
      </div>
    </div>

    <script type="text/javascript">

      var w = window.innerWidth - 50;
      var h = 50;
      var lastID = -1;
      var minHelpAvg = 0;
      var maxHelpAvg = 0;
      var totalWidth = 0;
      var curWidth = 0;
      var correct = 0;
      var posArray = [];
      var sortmode = 0;
      var clicked = 1;
      var sortArray = [];

      var dataset;
      d3.csv("tent.csv", function(error,data){
        if(error) {
          console.log(error);
        } else {
          dataset = data;

          dataset.forEach(function(d) {
            d["helpNeg"] = (d.helpAll - d.helpPos);
            d["helpAvg"] = (d.helpPos - d.helpNeg);
          });

          minHelpAvg = d3.min(data,function(d) {
            return parseInt(d.helpAvg);
          });
          maxHelpAvg = d3.max(data,function(d) {
            return parseInt(d.helpAvg)
          });

          dataset.forEach(function(d) {
            totalWidth += mapTo(d.helpAvg);
          });

          var w_tmp = 0;
          dataset.forEach(function(d) {
            w_tmp += mapToScreen(d.helpAvg);
          });

          if (w_tmp > w){
            correct = (w_tmp - w);
          }else if (w_tmp < w){
            correct = (w_tmp - w);
          }

          var timeFormat = d3.time.format("%B %d, %Y");
          dataset.forEach(function(d,i) {
            posArray.push({id: d.id, 
                           width: mapToScreen(d.helpAvg),
                           x: curWidth,
                           stars: ((d.rating*100)+(mapTo(d.helpAvg))+(d.id/1000)),
                           date: timeFormat.parse(d.date) });
            curWidth += mapToScreen(d.helpAvg);
          });

          dataset.forEach(function(d,i) {  
            sortArray.push({id: d.id, 
                            date: timeFormat.parse(d.date),
                            dateLabel: d.date,
                            stars: d.rating,
                            helpAvg: d.helpAvg,
                            x: 0
                          });
          })

          // sortArray.sort(function(a,b) { return a.date-b.date });

          var setupData = [];
          setupData = setup(data);

          draw(dataset,posArray,setupData,sortArray);
          // drawBarchart(data,posArray)
        }
      });

      function setup(data) {

        //horizontal chart setup
        var barSVG = d3.select(".horizontalChart")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h + 10);

        var bars = barSVG.selectAll("rect")
                         .data(data)
                         .enter()
                         .append("rect");

        var pointer = barSVG.append("polygon");

        var textBox = d3.select(".smartComments")
                        .select(".textBox")

        var colorScale = d3.scale.linear()
                           .domain([minHelpAvg,0,maxHelpAvg])
                           .range(["red","lightgray","green"]);

        //button setup
        var buttArray = [{id:0 ,state:"sort by: helpful", value:1},
                         {id:1 ,state:"sort by: date",  value:2},
                         {id:2 ,state:"sort by: stars",   value:3},
                         {id:3 ,state:"none",    value:4},
                         {id:4 ,state:"none",    value:5}];

        var buttonSVG = d3.select(".sortButtons")
                          .append("svg")
                          .attr("width", w)
                          .attr("height", 30);

        var buttons = buttonSVG.selectAll("rect")
                               .data(buttArray)
                               .enter()
                               .append("rect");

        var labels = buttonSVG.selectAll("text")
                              .data(buttArray)
                              .enter()
                              .append("text");

        //marker setup
        var marker = buttonSVG.selectAll("polygon")
                              .data(buttArray)
                              .enter()
                              .append("polygon");

        //bar chart setup
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            width = window.innerWidth - margin.left - margin.right,
            height = 100 - margin.top - margin.bottom;

        var barSVGh = d3.select(".barChart")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", 50+ height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate("+ margin.left + "," + margin.top + ")");

        var hBars = barSVGh.selectAll("rect")
                         .data(data)
                         .enter()
                         .append("rect"); 

        var xScale = d3.scale.ordinal()
                       .rangeRoundBands([0, width], .1);
        
        // var minDate = d3.min(sortArray,function(d) { return d.date });
        // var maxDate = d3.max(sortArray,function(d) { return d.date });
        // var xScale = d3.time.scale().domain([minDate,maxDate]).range([0,width]);

        var yScale = d3.scale.linear()
                       .range([height, 0]);

        var xAxis = d3.svg.axis()
                          .scale(xScale)
                          .orient("bottom");

        var yAxis = d3.svg.axis()
                          .scale(yScale)
                          .orient("left")
                          .ticks(6);

        //return values
        var values = [buttonSVG,barSVG,bars,buttons,labels,
                      buttArray,marker,textBox,colorScale,
                      pointer,barSVGh,xScale,yScale,hBars,
                      xAxis,yAxis,margin,width,height];
        
        return values;
      }

      function draw(data,posArray,setupData,sortArray) {

        var buttonSVG = setupData[0];
        var barSVG    = setupData[1];
        var bars      = setupData[2];
        var buttons   = setupData[3];
        var labels    = setupData[4];
        var buttArray = setupData[5];
        var marker    = setupData[6];
        var textBox   = setupData[7];
        var colScl    = setupData[8];
        var pointer   = setupData[9];
        var barSVGh   = setupData[10];
        var xScale    = setupData[11];
        var yScale    = setupData[12];
        var hBars     = setupData[13];
        var xAxis     = setupData[14];
        var yAxis     = setupData[15];
        var margin    = setupData[16];
        var width     = setupData[17];
        var height    = setupData[18];

        var bCnt = buttArray.length; // buttonCount

        pointer.attr("id", "p")
               .style("fill", "white")
               .style("stroke", "white"); 

        // --- VERTICAL - BARCHART --------------------------------------------------------------- //
        // --------------------------------------------------------------------------------------- //
        xScale.domain(sortArray.map(function(d,i) { return sortArray[i].id; }));
        yScale.domain([0, d3.max(data, function(d,i) { return sortArray[i].stars; })]);


        barSVGh.append("g")
               .attr("class", "x axis foo")
               .attr("transform", "translate(0," + height + ")")
               .call(xAxis)
               .selectAll("text")
               .attr("dx", "-.8em")
               .attr("dy", ".15em")
               .style("text-anchor", "end")
               .attr("transform", function(d) { return "rotate(-45)" })
               // .text(function(d,i) { return sortArray[i].dateLabel });

        barSVGh.append("g")
               .attr("class", "y axis")
               .call(yAxis)
               .append("text")
               .attr("transform", "rotate(-90)")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text("Stars");

        hBars.attr("id", function(d,i) { return "b"+sortArray[i].id })
              .attr("x", function(d,i) {
                 return xScale(sortArray[i].id);
               })
              .attr("width", xScale.rangeBand())
              .attr("y", function(d,i) { return yScale(sortArray[i].stars); })
              .attr("height", function(d,i) { return height - yScale(sortArray[i].stars); })
              .attr("fill", "lightgrey")
              .on("mouseover", function(d,i) {
                barSVGh.select("#b"+i).attr("fill", "gold");
                barSVG.select("#r"+i).attr("fill", "gold");
               })
              .on("mouseout", function(d,i) { 
                barSVGh.select("#b"+i).attr("fill", "lightgrey");
                barSVG.select("#r"+i).attr("fill", colScl(d.helpAvg));
               })
              .on("click", function(d,i) { 
                sortmode += 1;
                sortTimeline(sortArray,barSVGh,sortmode,xScale,width,height,xAxis);
               });
    
        // --- HORIZONTAL - BARCHART ------------------------------------------------------------- //
        // --------------------------------------------------------------------------------------- //
        bars.attr("id", function(d,i) { return "r" + i; })
            .attr("x", function(d,i) { return posArray[i].x })
            .attr("y", 0)
            .attr("width", function(d,i) { return posArray[i].width })
            .attr("height", h)
            .attr("stroke", "white")
            .attr("fill", function(d) {
              return colScl(d.helpAvg);
            })
            .on("mouseover",  function(d,i) {
              barSVG.select("#r"+parseInt(d.id))
                    .transition()
                    .duration(150)
                    .attr("fill", "gold");

              var getRectX = barSVG.select("#r"+parseInt(d.id)).attr("x");
              var rectX = getRectX;
              var showPara = 1;
              showInfo(d,textBox,showPara,rectX);

              var width = findByID(posArray,i).width;
              var x = findByID(posArray,i).x;
              var x1 = x+(width/2);

              barSVG.select("#p") 
                    .style("fill", "gold")
                    .style("stroke", "gold")
                    .attr("points",(x1+","+50+","+(x1-10)+","+60+","+(x1+10)+","+60) );

              barSVGh.select("#b"+i)
                     .transition()
                     .duration(150)
                     .style("fill","gold");

            })
            .on("mouseout",function (d,i) {
              barSVG.select("#r"+parseInt(d.id))
                 .transition()
                 .duration(150)
                 .attr("fill", colScl(d.helpAvg));
              var showPara = 0;
              showInfo(d,showPara);

              barSVG.select("#p") 
                    .style("fill", "white")
                    .style("stroke", "white");

              barSVGh.select("#b"+i)
                     .transition()
                     .duration(150)
                     .style("fill","lightgrey");
             });


        // --- BUTTONS --------------------------------------------------------------------------- //
        // --------------------------------------------------------------------------------------- //
        buttons.attr("id", function(d,i) { return "b"+i; })
               .attr("x", function(d,i) { return i*(w/bCnt); })
               .attr("y", 0)
               .attr("width", function(d,i) { return (w/bCnt)-20; })
               .attr("height", 25)
               .attr("rx", 12)
               .attr("ry", 12)
               .attr("fill", "lightgrey")
               .on("click", function(d) {
                  clicked = clicked*-1;
                  var buttonState = clicked*d.value;
                  sortBars(posArray,barSVG,buttonState);
                  changeMarkerState(buttonSVG,marker,buttonState,d.id);
                });

        labels.attr("id", function(d,i) { return "l"; })
              .text(function(d,i) { return buttArray[i].state; })
              .attr("x", function(d,i) { return i*(w/bCnt) + ((w/bCnt)/2-10);  })
              .attr("y", 18)
              .attr("width", function(d,i) { return (w/bCnt)-20; })
              .attr("height", 20)
              .attr("text-anchor", "middle");

        marker.attr("id", function(d,i) { return "m"+i; })
              .style("stroke", "black")
              .style("fill", "black")
              .attr("points", function(d,i) {
                  return ((i*(w/bCnt)+(w/bCnt)-40)+","+8+","+
                          (i*(w/bCnt)+(w/bCnt)-40)+","+18+","+
                          (i*(w/bCnt)+(w/bCnt)-30)+","+13);
               });
      }

      function showInfo(data, textBox, showPara, rectX){

        if (showPara == 1){
          d3.select(".textNr")
            .text("Nr.:" + data.id);
          d3.select(".textNr")
            .text("Nr.:" + data.id);
          d3.select(".textInfo")
            .text("Sterne: "+ data.rating + "\n" + data.infoText);
          textStyle(textBox,rectX);
        }
        else if(showPara == 0){
          d3.select(".textNr")
            .text("");
          d3.select(".textInfo")
            .text("");
        }
      }

      function textStyle(textBox, rectX) {
        if(rectX < 400) {
          textBox.transition()
            .duration(180)
            .style("width", "800px")
            .style("height", "200px")
            .style("margin-left", 25+"px");
        } else if (rectX > (w-400)) {
          textBox.transition()
            .duration(180)
            .style("width", "800px")
            .style("height", "200px")
            .style("margin-left", (w-800+25)+"px");
        } else {
          textBox.transition()
            .duration(180)
            .style("width", "800px")
            .style("height", "200px")
            .style("margin-left", (rectX-400+25)+"px");
        }
      };

      function mapToScreen(val) {
        var m = d3.scale.linear()
								  .domain([0,totalWidth])
								  .range([1,w-correct]);
        return m(mapTo(val));
      }

      function mapTo(val) {
        var s = d3.scale.linear()
                  .domain([minHelpAvg,maxHelpAvg])
                  .range([1,10]);
        return s(val);
      }

      var sortBars = function(posArray,svg,buttonState) {
        curWidth = 0;

        if(buttonState == 1) { //sort by helpful ascending
          posArray.sort(function(a,b) { return a.width - b.width; });
        } else if(buttonState == -1){ //descending
          posArray.sort(function(a,b) { return b.width - a.width; });
        } else if(buttonState == 2) { //sort by date ascending
          posArray.sort(function(a,b) { return a.date - b.date; });
        } else if(buttonState == -2) { // descending
          posArray.sort(function(a,b) { return b.date - a.date; });
        } else if (buttonState == 3) { //sort by stars ascending
          posArray.sort(function(a,b) { return a.stars - b.stars; });
        } else if (buttonState == -3) { // descending
          posArray.sort(function(a,b) { return b.stars - a.stars; });
        }

        posArray.forEach(function(d,i) {
          var w_tmp = posArray[i].width;
          posArray[i].x = curWidth;
          curWidth += w_tmp;
          svg.select("#r"+(posArray[i].id))
             .transition()
             .duration(1000)
             .attr("x", function(d) {
                return posArray[i].x;
              })
        });
      }

      function sortTimeline(sortArray,svg,sortmode,xScale,width,height,xAxis) {

        if(sortmode%4 == 0) {
          sortArray.sort(function(a,b) { return a.date-b.date;});
        } else if (sortmode%4 == 1) {
          sortArray.sort(function(a,b) { return b.date-a.date;});
        } else if (sortmode%4 == 2) {
          sortArray.sort(function(a,b) { return a.stars-b.stars;});
        } else if (sortmode%4 == 3) {
          sortArray.sort(function(a,b) { return b.stars-a.stars;});
        }

        xScale.domain(sortArray.map(function(d,i) { return sortArray[i].id; }));

        // var x0 = xScale.domain(sortArray.sort(this.checked
        //   ? function(a, b) { return b.id - a.id; }
        //   : function(a, b) { return d3.ascending(a.date, b.date); })
        //   .map(function(d) { return d.id; }))
        //   .copy();

        var transition = svg.transition().duration(200),
            delay = function(d, i) { return i * 50; };
        
        sortArray.forEach(function(d,i) {  
          svg.select("#b"+sortArray[i].id)
             .transition()
             .duration(300)
             .attr("x", function(d) {
                return xScale(sortArray[i].id);
              });
          })
       
        // transition.selectAll(".barChart")
        //           .delay(delay)
        //           .attr("x", function(d) { return x0(d.date); });

        transition.select(".x.axis")
                  .call(xAxis)
                  .append("text")
                  // .text(function(d,i) { return sortArray[i].dateLabel })

      }

      function changeMarkerState(svg,marker,buttonState,buttonID) {
        console.log(buttonID);
        var points = svg.select("#m"+buttonID).attr("points");
        var pntArray = points.split(",").map(Number);

        if(buttonState > 0) {
          svg.select("#m"+buttonID)
             .attr("transform", "rotate("+180+","+(pntArray[0]+5) +","+pntArray[5]+")");
        } else if (buttonState < 0) {
          svg.select("#m"+buttonID)
             .attr("transform", "rotate("+360+","+(pntArray[0]+5) +","+pntArray[5]+")");
        }
      }

      function findByID(src,id) {
        return src.filter( function(obj) {
          return +obj.id == id;
        })[0];
      }

    </script>
  </body>
</html>
