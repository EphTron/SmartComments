<!DOCTYPE html>
<html>
    <head>
        <title>Visu Beleg</title>
		<link rel="stylesheet" href="indexstyle.css">
		<link rel="stylesheet" href="./scroll/onepage-scroll.css" >
		<script type="text/javascript" src="d3/d3.v3.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<script type="text/javascript" src="./scroll/jquery.onepage-scroll.js"></script>

		<meta charset="UTF-8">
    </head>
    <body>
		<div class="wrapper">
			<div class="main">
				
				<section class="page1">
				<div class="mainFrame">
						<h1>Product</h1>
						<div class="productPicture">
							<img src="./pictures/bag.png" alt="Picture Bag">
						</div>
						<div class="productInfo">
							<h4>MUMIENSCHLAFSACK LIGHT 600 4651</h4>
							<p>von Unbekannt</p>
							<p><img src="./pictures/stars.png" alt="Picture Stars"> 84 Kundenrezensionen</p>
							<p>Preis:  17,90</p>
							<p>AUF LAGER</p>
						</div>
				</div>
				</section>
					
				<section class="page2">
				  <div class="smartComments">
							<h4>Kundenrezensionen</h4>
							<div class="sortButtons">
							</div>
							<div class="barChart">
							</div>
							<div class="textBox">
								<p class="textNummer"></p>
								<p class="textTitle"></p>
								<p class="textInfo"></p>
								
							</div>
				  </div>
				</section>
			</div>
		</div>
		
		<script type="text/javascript">
			  
			var w = 1100;
			var h = 50;
			var clickcounter = 0;
			var lastID = -1;
      var minHelpAvg = 0;
      var maxHelpAvg = 0;
      var totalWidth = 0;
      var curWidth = 0;
      
			var dataset;
			d3.csv("bag.csv", function(error,data){
				if(error) {
					console.log(error);
				} else {
					dataset = data;
					
					dataset.forEach(function(d) {
						d["helpNeg"] = (d.helpAll - d.helpPos);
						d["helpAvg"] = (d.helpPos - d.helpNeg);
					});
          
         
          
          minHelpAvg = d3.min(data,function(d) {
            return parseInt(d.helpAvg);
          });
          maxHelpAvg = d3.max(data,function(d) {
            return parseInt(d.helpAvg)
          });
          
          
          var posArray = [];
          dataset.forEach(function(d) {
            totalWidth +=  parseInt(mapTo(d.helpAvg));
            
            posArray.push({id: d.id, width: mapToScreen(d.helpAvg),x: curWidth});
            curWidth += mapToScreen(d.helpAvg);
					});
          console.log(posArray);
					
          
					drawBarChart(dataset,posArray);
				}
			});

      
			function drawBarChart(data,posArray) {
        
        var svg = d3.select(".barChart")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h + 10);
							
				var bars = svg.selectAll("rect")
                      .data(data)
                      .enter()
                      .append("rect");
                      
        var textBox = d3.select(".smartComments")
				                .select(".textBox")
        
				var colScl = d3.scale.linear()
								  .domain([minHelpAvg,0,maxHelpAvg])
								  .range(["red","lightgray","green"]);
								
				bars.attr("id", function(d,i) { return "r" + i; })
				    //.attr("x", function(d,i) { return calcX(d,i,scl,svg); })
            .attr("x", function(d,i) { return posArray[i].x })
            .attr("y", 0)
				    .attr("width", function(d,i) { return posArray[i].width })
            .attr("height", h)
            .attr("fill", function(d) {
					    return colScl(parseInt(d.helpAvg));
            })
            .on("mouseover",  function(d,i) {
              var showPara = 1;
              showInfo(d,showPara);
            })
            .on("mouseout",function (d) {
              var showPara = 0;
              showInfo(d,showPara);
            });
			}
			
			function showInfo(data, showPara){
				if (showPara == 1){
				d3.select(".textNr")
				  .text("Kundenrezension Nr.:" + data.id + " von " + data.name );
				  
				d3.select(".textInfo")
				  .text("Sterne: "+ data.rating + "\n" + data.infoText);
				} 
				else if(showPara == 0){
				d3.select(".textNr")
				  .text("");
				  
				d3.select(".textInfo")
				  .text("");
				}
			}
      
      function mapToScreen(val) {
        var m = d3.scale.linear()
								  .domain([0,343])
								  .range([1,1100]);
        return m(val);
      }
      
      function mapTo(val) {
        var s = d3.scale.linear()
                  .domain([minHelpAvg,maxHelpAvg])
                  .range([1,10]);
        return parseInt(s(val));
      }
      
			//function calcWidth(d,i,scale) {
			//	return scale(preScl(parseInt(dataset[i].helpAvg)));
			//}

			function calcX(d,i,scale,svg) {
				if(i == 0) {
					return 0;
				} else {
					var wold = mapToScreen(posArray[i-1].width);
					var xold = svg.select("#r"+(i-1)).attr('x');
					return parseFloat(xold) + wold; 
				}
			}

		</script>
		<script>
		  $(document).ready(function(){
			  $(".main").onepage_scroll({
				sectionContainer: "section",
				responsiveFallback: 600,
				loop: false
				});
		  });
		</script>
    </body>
</html>